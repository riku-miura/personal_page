(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();let u;const g=new Uint8Array(16);function E(){if(!u&&(u=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!u))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return u(g)}const a=[];for(let s=0;s<256;++s)a.push((s+256).toString(16).slice(1));function y(s,e=0){return a[s[e+0]]+a[s[e+1]]+a[s[e+2]]+a[s[e+3]]+"-"+a[s[e+4]]+a[s[e+5]]+"-"+a[s[e+6]]+a[s[e+7]]+"-"+a[s[e+8]]+a[s[e+9]]+"-"+a[s[e+10]]+a[s[e+11]]+a[s[e+12]]+a[s[e+13]]+a[s[e+14]]+a[s[e+15]]}const f=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),m={randomUUID:f};function v(s,e,t){if(m.randomUUID&&!e&&!s)return m.randomUUID();s=s||{};const i=s.random||(s.rng||E)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){t=t||0;for(let n=0;n<16;++n)e[t+n]=i[n];return e}return y(i)}class h{static validateText(e){const t=e.trim();return t.length===0?{isValid:!1,error:"Note text cannot be empty"}:t.length>this.MAX_TEXT_LENGTH?{isValid:!1,error:`Note text cannot exceed ${this.MAX_TEXT_LENGTH} characters`}:{isValid:!0}}static validateNote(e){return!e.id||typeof e.id!="string"?{isValid:!1,error:"Note must have a valid ID"}:typeof e.createdAt!="number"||e.createdAt<=0?{isValid:!1,error:"Note must have a valid creation timestamp"}:!e.position||typeof e.position.x!="number"||typeof e.position.y!="number"||e.position.x<0||e.position.y<0?{isValid:!1,error:"Note must have a valid position with non-negative coordinates"}:typeof e.isEditing!="boolean"?{isValid:!1,error:"Note editing state must be a boolean"}:this.validateText(e.text)}static sanitizeText(e){return e.replace(/<[^>]*>/g,"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").trim().substring(0,this.MAX_TEXT_LENGTH)}}h.MAX_TEXT_LENGTH=200;class C extends Error{constructor(){super("Browser cache quota exceeded"),this.name="CacheQuotaExceededError"}}class b extends Error{constructor(){super("Cache API is not available in this browser"),this.name="CacheUnavailableError"}}class x extends Error{constructor(e){super(`Invalid note data: ${e}`),this.name="InvalidNoteDataError"}}class w extends Error{constructor(e,t){super(`Cache operation '${e}' failed${t?`: ${t}`:""}`),this.name="CacheOperationError"}}class A{constructor(){this.CACHE_NAME="cache-sticky",this.URL_PREFIX="https://cache-sticky.local/notes/"}isCacheAvailable(){return typeof window<"u"&&"caches"in window}getRequestUrl(e){return`${this.URL_PREFIX}${e}`}createRequest(e){return new Request(this.getRequestUrl(e))}createResponse(e){return new Response(JSON.stringify(e),{headers:{"Content-Type":"application/json","X-Created-At":e.createdAt.toString()}})}async storeNote(e){if(!this.isCacheAvailable()){console.warn("Cache API not available, note will not persist");return}const t=h.validateNote(e);if(!t.isValid)throw new x(t.error||"Unknown validation error");try{const i=await caches.open(this.CACHE_NAME),n=this.createRequest(e.id),o=this.createResponse(e);await i.put(n,o),console.log(`Note ${e.id} stored successfully`)}catch(i){if(console.warn(`Failed to store note ${e.id}:`,i),i instanceof Error){if(i.message.includes("quota")||i.name==="QuotaExceededError")throw new C;console.warn("Note storage failed but continuing without persistence");return}}}async getNote(e){if(!this.isCacheAvailable())return console.warn("Cache API not available, returning null"),null;try{const t=await caches.open(this.CACHE_NAME),i=this.createRequest(e),n=await t.match(i);if(!n)return null;const o=await n.json(),r=h.validateNote(o);return r.isValid?o:(console.warn(`Invalid note data for ${e}: ${r.error}`),null)}catch(t){return console.warn(`Failed to get note ${e}:`,t),null}}async getAllNotes(){if(!this.isCacheAvailable())return[];try{const e=await caches.open(this.CACHE_NAME),i=(await e.keys()).filter(o=>o.url.startsWith(this.URL_PREFIX)).map(async o=>{try{const r=await e.match(o);if(!r)return null;const l=await r.json(),d=h.validateNote(l);return d.isValid?l:(console.warn(`Skipping corrupted note: ${d.error}`),null)}catch(r){return console.warn(`Failed to load note from ${o.url}:`,r),null}});return(await Promise.all(i)).filter(o=>o!==null)}catch(e){return console.warn("Cache API is not available or encountered an error, using memory-only mode:",e),[]}}async clearAllNotes(){if(!this.isCacheAvailable())throw new b;try{const e=await caches.open(this.CACHE_NAME),i=(await e.keys()).filter(n=>n.url.startsWith(this.URL_PREFIX)).map(n=>e.delete(n));await Promise.all(i)}catch(e){throw e instanceof Error?new w("clearAllNotes",e.message):new w("clearAllNotes","Unknown error")}}}class T{constructor(){this.NOTE_WIDTH=200,this.NOTE_HEIGHT=150,this.GRID_SPACING=20,this.START_X=20,this.START_Y=20,this.CONTAINER_WIDTH=800,this.inMemoryNotes=new Map,this.cacheService=new A}async createNewNote(e){const t=e||await this.getNextPosition(),i={id:v(),text:"",createdAt:Date.now(),position:t,isEditing:!0};return this.inMemoryNotes.set(i.id,i),i}async getNextPosition(){const e=await this.cacheService.getAllNotes(),t=Array.from(this.inMemoryNotes.values()),n=[...e,...t].reduce((c,p)=>(c.set(p.id,p),c),new Map),o=new Set(Array.from(n.values()).map(c=>`${c.position.x},${c.position.y}`));["20,20","240,20","460,20","20,190"].forEach(c=>o.add(c));let l=this.START_X,d=190+this.NOTE_HEIGHT+this.GRID_SPACING;for(;;){const c=`${l},${d}`;if(!o.has(c))return{x:l,y:d};l+=this.NOTE_WIDTH+this.GRID_SPACING,l+this.NOTE_WIDTH>this.CONTAINER_WIDTH&&(l=this.START_X,d+=this.NOTE_HEIGHT+this.GRID_SPACING)}}async saveNote(e,t){const i=this.validateNoteText(t);if(!i.isValid)throw new Error(i.error);const n=h.sanitizeText(t),o=this.inMemoryNotes.get(e),r=await this.cacheService.getNote(e),l=(o==null?void 0:o.position)||(r==null?void 0:r.position)||await this.getNextPosition(),d={id:e,text:n,createdAt:(o==null?void 0:o.createdAt)||(r==null?void 0:r.createdAt)||Date.now(),position:l,isEditing:!1};this.inMemoryNotes.set(e,d);try{await this.cacheService.storeNote(d),console.log(`Note ${e} stored successfully in cache`)}catch(c){console.warn(`Save operation completed with warnings for note ${e}:`,c)}}cancelNoteEdit(e){this.inMemoryNotes.delete(e),console.log(`Cancelling edit for note: ${e}`)}async loadAllNotes(){return await this.cacheService.getAllNotes()}validateNoteText(e){return h.validateText(e)}async initialize(){}}class S{constructor(e,t,i){this.note=e,this.onSave=t,this.onCancel=i,this.element=this.createElement()}createElement(){const e=document.createElement("div");return e.className=`sticky-note ${this.note.isEditing?"editing":""}`,e.id=`note-${this.note.id}`,e.style.left=`${this.note.position.x}px`,e.style.top=`${this.note.position.y}px`,this.note.isEditing?this.createEditingView(e):this.createStaticView(e),e}createEditingView(e){const t=document.createElement("textarea");t.className="note-textarea",t.value=this.note.text,t.maxLength=200,t.placeholder="メッセージを入力してください（最大200文字）";const i=document.createElement("div");i.className="char-count",this.updateCharCount(i,t.value.length),t.addEventListener("input",n=>{const o=n.target;this.updateCharCount(i,o.value.length),o.value.length>200&&(o.value=o.value.substring(0,200),this.updateCharCount(i,200))}),t.addEventListener("blur",()=>{this.handleSave(t.value)}),t.addEventListener("keydown",n=>{n.key==="Enter"&&!n.shiftKey?(n.preventDefault(),this.handleSave(t.value)):n.key==="Escape"&&(n.preventDefault(),this.handleCancel())}),e.appendChild(t),e.appendChild(i),setTimeout(()=>t.focus(),0)}createStaticView(e){const t=document.createElement("div");t.className="note-text",t.textContent=this.note.text;const i=document.createElement("div");i.className="note-timestamp",i.textContent=new Date(this.note.createdAt).toLocaleString(),e.appendChild(t),e.appendChild(i)}updateCharCount(e,t){const i=200-t;e.textContent=`残り${i}文字`,e.className=`char-count ${i<20?"warning":""}`}handleSave(e){const t=e.trim();if(t.length===0){this.showError("メッセージが空です");return}this.onSave&&this.onSave(this.note.id,t)}handleCancel(){this.onCancel&&this.onCancel(this.note.id)}showError(e){const t=this.element.querySelector(".error-message");t&&t.remove();const i=document.createElement("div");i.className="error-message",i.textContent=e,this.element.appendChild(i),setTimeout(()=>{i.parentNode&&i.remove()},3e3)}getElement(){return this.element}updateNote(e){this.note=e;const t=this.element.parentNode,i=this.createElement();t&&t.replaceChild(i,this.element),this.element=i}remove(){this.element.parentNode&&this.element.parentNode.removeChild(this.element)}}class k{constructor(e){this.onClick=e,this.element=this.createElement()}createElement(){const e=document.createElement("button");return e.id="new-note-btn",e.className="new-note-button",e.textContent="New Note",e.title="Create a new sticky note",e.addEventListener("click",()=>{this.onClick&&this.onClick()}),e}getElement(){return this.element}setEnabled(e){this.element.disabled=!e,e?this.element.classList.remove("disabled"):this.element.classList.add("disabled")}updateText(e){this.element.textContent=e}}class M{constructor(){this.noteComponents=new Map,this.isCreatingNote=!1,this.whiteboardService=new T,this.newNoteButton=new k(()=>this.handleNewNoteClick()),this.element=this.createElement()}createElement(){const e=document.createElement("div");e.id="app",e.className="whiteboard-container";const t=document.createElement("div");return t.id="whiteboard",t.className="whiteboard",e.appendChild(t),e}async handleNewNoteClick(){if(this.isCreatingNote){this.showMessage("現在編集中の付箋を先に完了してください","warning");return}try{this.isCreatingNote=!0,this.newNoteButton.setEnabled(!1),this.setAllNotesNonEditable();const e=await this.whiteboardService.createNewNote();this.addNoteToDOM(e),this.showMessage("新しい付箋が作成されました - 入力してください！","info")}catch(e){console.error("Failed to create new note:",e),this.showMessage("新しい付箋の作成に失敗しました","error"),this.isCreatingNote=!1,this.newNoteButton.setEnabled(!0)}}setAllNotesNonEditable(){this.noteComponents.forEach((e,t)=>{const i=e.getElement();if(i.classList.contains("editing")){const n=i.querySelector("textarea");n&&n.value.trim()?this.handleNoteSave(t,n.value):this.handleNoteCancel(t)}})}addNoteToDOM(e){const t=new S(e,(n,o)=>this.handleNoteSave(n,o),n=>this.handleNoteCancel(n));this.noteComponents.set(e.id,t),this.element.querySelector("#whiteboard").appendChild(t.getElement())}async handleNoteSave(e,t){try{await this.whiteboardService.saveNote(e,t);const i=this.noteComponents.get(e),n=i==null?void 0:i.getElement(),o=n?{x:parseInt(n.style.left)||0,y:parseInt(n.style.top)||0}:{x:0,y:0},r={id:e,text:t,createdAt:Date.now(),position:o,isEditing:!1};i&&i.updateNote(r),this.isCreatingNote=!1,this.newNoteButton.setEnabled(!0),this.showMessage("付箋が正常に保存されました！","success")}catch(i){console.error("Failed to save note:",i),this.showMessage(`付箋の保存に失敗しました: ${i instanceof Error?i.message:"不明なエラー"}`,"error")}}handleNoteCancel(e){const t=this.noteComponents.get(e);t&&(t.remove(),this.noteComponents.delete(e)),this.whiteboardService.cancelNoteEdit(e),this.isCreatingNote=!1,this.newNoteButton.setEnabled(!0),this.showMessage("付箋の作成がキャンセルされました","info")}showMessage(e,t){this.element.querySelectorAll(".message").forEach(r=>r.remove());const n=document.createElement("div");n.className=`message message-${t}`,n.textContent=e;const o=this.element.querySelector("#whiteboard");o?o.insertBefore(n,o.firstChild):this.element.insertBefore(n,this.element.firstChild),setTimeout(()=>{n.parentNode&&n.remove()},5e3)}async loadExistingNotes(){try{await this.whiteboardService.initialize();const e=await this.whiteboardService.loadAllNotes();e.forEach(t=>{this.addNoteToDOM(t)}),e.length>0&&this.showMessage(`キャッシュから${e.length}個の付箋を読み込みました`,"success")}catch(e){console.error("Failed to load existing notes:",e),this.showMessage("既存の付箋の読み込みに失敗しました","error")}}getElement(){return this.element}async initialize(){await this.createInstructionNotes(),await this.loadExistingNotes()}async createInstructionNotes(){try{const e=["「＋新しいふせん」でふせんを追加","メッセージを入力（最大200文字）","ブラウザキャッシュを削除（開発者ツール → Application → Storage）すると、ふせんが消えます"];for(let t=0;t<e.length;t++){const i={id:`instruction-${t+1}`,text:e[t],createdAt:Date.now(),position:{x:20+t*220,y:20},isEditing:!1};this.addInstructionNoteToDOM(i)}this.createNewNoteButton()}catch(e){console.error("Failed to create instruction notes:",e)}}addInstructionNoteToDOM(e){const t=document.createElement("div");t.className="sticky-note instruction-note",t.id=`note-${e.id}`,t.style.left=`${e.position.x}px`,t.style.top=`${e.position.y}px`;const i=document.createElement("div");i.className="note-text",i.textContent=e.text,t.appendChild(i),this.element.querySelector("#whiteboard").appendChild(t)}createNewNoteButton(){const e=document.createElement("div");e.className="sticky-note new-note-sticky",e.style.left="20px",e.style.top="190px",e.style.cursor="pointer";const t=document.createElement("div");t.className="plus-icon",t.textContent="+";const i=document.createElement("div");i.className="new-note-label",i.textContent="新しいふせん",e.appendChild(t),e.appendChild(i),e.addEventListener("click",()=>this.handleNewNoteClick()),this.element.querySelector("#whiteboard").appendChild(e)}}class R{constructor(){this.whiteboard=new M}async initialize(){try{const e=document.getElementById("app");e?e.replaceWith(this.whiteboard.getElement()):document.body.appendChild(this.whiteboard.getElement()),await this.whiteboard.initialize(),window.addEventListener("error",this.handleGlobalError.bind(this)),window.addEventListener("unhandledrejection",this.handleUnhandledRejection.bind(this)),console.log("Cache Sticky application initialized successfully")}catch(e){console.error("Failed to initialize application:",e),this.showFallbackUI()}}handleGlobalError(e){console.error("Global error:",e.error),this.showErrorMessage("An unexpected error occurred. Please refresh the page.")}handleUnhandledRejection(e){console.error("Unhandled promise rejection:",e.reason),this.showErrorMessage("An error occurred while processing your request.")}showErrorMessage(e){const t=document.createElement("div");t.className="global-error",t.innerHTML=`
      <div class="error-content">
        <h2>Error</h2>
        <p>${e}</p>
        <button onclick="location.reload()">Refresh Page</button>
      </div>
    `,document.body.insertBefore(t,document.body.firstChild),setTimeout(()=>{t.parentNode&&t.remove()},1e4)}showFallbackUI(){const e=`
      <div id="fallback-app">
        <h1>Cache Sticky</h1>
        <div class="fallback-message">
          <h2>Application failed to load</h2>
          <p>This could be due to:</p>
          <ul>
            <li>JavaScript disabled in your browser</li>
            <li>Unsupported browser version</li>
            <li>Network connectivity issues</li>
          </ul>
          <p>Please try:</p>
          <ul>
            <li>Refreshing the page</li>
            <li>Enabling JavaScript</li>
            <li>Using a modern browser (Chrome 40+, Firefox 41+, Safari 11.1+)</li>
          </ul>
          <button onclick="location.reload()">Refresh Page</button>
        </div>
      </div>
    `;document.body.innerHTML=e}}async function N(){try{console.log("Starting Cache Sticky application..."),await new R().initialize(),console.log("Application initialized successfully")}catch(s){console.error("Failed to initialize application:",s),document.body.innerHTML=`
      <div id="fallback-app">
        <h1>Cache Sticky</h1>
        <div class="fallback-message">
          <h2>Application failed to load</h2>
          <p>Error: ${s instanceof Error?s.message:"Unknown error"}</p>
          <button onclick="location.reload()">Refresh Page</button>
        </div>
      </div>
    `}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",N):N();
